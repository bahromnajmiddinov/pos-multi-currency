<?xml version="1.0" encoding="UTF-8"?>
<templates id="template" xml:space="preserve">
    
    <t t-inherit="point_of_sale.OrderReceipt" t-inherit-mode="extension">
        
        <!-- Add receipt currency header if conversion is active -->
        <xpath expr="//div[@class='pt-3'][1]" position="before">
            <div t-if="shouldShowOriginalAmount()" 
                 class="receipt-currency-info text-center mb-2 p-2 bg-light border rounded">
                <small class="text-muted">
                    <i class="fa fa-info-circle me-1"/>
                    All amounts displayed in <strong><t t-esc="receiptCurrencyInfo.name"/></strong>
                    <br/>
                    (Original currency: <t t-esc="order.currency.name"/>)
                </small>
            </div>
        </xpath>

        <!-- Modify total section to show both currencies if needed -->
        <xpath expr="//div[@class='pos-receipt-amount receipt-total fw-bolder']" position="replace">
            <div class="pos-receipt-amount receipt-total fw-bolder">
                <span class="label-total">Total</span>
                <span t-out="formatCurrency(order.amount_total)" class="pos-receipt-right-align font-monospace"/>
            </div>
            <!-- Show original amount if converted -->
            <div t-if="shouldShowOriginalAmount()" class="pos-receipt-amount text-muted" style="font-size: 0.9em;">
                <span class="label-original">Original:</span>
                <span t-out="formatOriginalAmount(order.amount_total)" class="pos-receipt-right-align font-monospace"/>
            </div>
        </xpath>

        <!-- Modify payment lines to show converted amounts -->
        <xpath expr="//div[@class='paymentlines text-start pt-1']" position="replace">
            <div class="paymentlines text-start pt-1" t-foreach="paymentLines" t-as="line" t-key="line_index">
                <t t-esc="line.payment_method_id.name"/>
                <span t-out="formatCurrency(line.getAmount())" class="pos-receipt-right-align font-monospace"/>
                
                <!-- Show original amount if converted -->
                <t t-if="shouldShowOriginalAmount()">
                    <div class="mc-receipt-sub-line text-muted" style="font-size: 0.85em; margin-left: 1em;">
                        (<t t-esc="formatOriginalAmount(line.getAmount())"/>)
                    </div>
                </t>
                
                <!-- Multi-currency payment info (if applicable) -->
                <t t-if="line.isMultiCurrency and line.isMultiCurrency()">
                    <div class="mc-receipt-sub-line">
                        <span class="mc-receipt-converted">
                            (Paid: <t t-esc="line.payment_currency_id.symbol || line.payment_currency_id.name"/>
                            <t t-esc="line.getPaymentCurrencyAmount().toFixed(2)"/>)
                        </span>
                    </div>
                </t>
            </div>
        </xpath>

        <!-- Add exchange rate footer if conversion is active -->
        <xpath expr="//div[@class='pos-receipt-order-data text-center pt-3']" position="before">
            <div t-if="shouldShowOriginalAmount() and receiptCurrencyInfo" 
                 class="receipt-exchange-rate text-center pt-2 pb-2 border-top">
                <small class="text-muted">
                    Exchange Rate: 1 <t t-esc="order.currency.name"/> = 
                    <t t-esc="receiptCurrencyInfo.rate.toFixed(4)"/> <t t-esc="receiptCurrencyInfo.name"/>
                </small>
            </div>
        </xpath>

    </t>

</templates>